---
title: "Gravity-fed Bioreactor Column Study"
author: "Katie L. Duggan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---
## Files needed:

- "GFBR_icp_ic_results.csv"

## Load packages & set directory
```{r, include=FALSE}
#install.packages("tidyverse")
library(tidyverse)
library(ggpubr)
```

## Load data
```{r}
icp_ic_results <- read_csv("C:/github/WBR-microbiome/data/GFBR_icp_ic_results.csv") %>% 
  unite(datetime, c(date, time), sep = " ", remove = FALSE) #combine date and time
```

## P trends across length of each run
```{r}
## Subset the data
control_run <- icp_ic_results %>% 
  filter(!replicate == "STOCK") %>%
  filter(!treatment == "P") %>% 
  filter(!treatment == "P+N")

P_run <- icp_ic_results %>% 
  filter(!replicate == "STOCK") %>%
  filter(!treatment == "Control")%>% 
  filter(!treatment == "P+N")

NP_run <- icp_ic_results %>% 
  filter(!replicate == "STOCK") %>%
  filter(!treatment == "Control")%>% 
  filter(!treatment == "P")

## Control run
breaks_C <- control_run %>% 
  pull(hours_after_start) %>% 
  unique()

timepoints_C <- ifelse(breaks_C > 120, breaks_C - 168, breaks_C)

control_run %>%
  ggplot(aes(x = hours_after_start, y = P, color = reactor)) +
  geom_line() +
  scale_x_continuous(breaks = breaks_C, labels = timepoints_C) +
  facet_wrap(~replicate, ncol = 1) +
  geom_vline(xintercept = c(120, 168, 288), color="#BB0000", linetype="dashed") +
  theme_classic() +
  labs(title = "Phosphorus Trends in Gravity-fed Column Reactors - Control Run", color = "Reactor:") +
  xlab("Hours After Start") +
  ylab ("Phosphorus Concentration (mg/L)") +
  theme(legend.position = "bottom",
        panel.grid.major = element_line(color = "grey", linewidth = 0.25, linetype = 2),
        panel.grid.minor = element_line(color = "grey", linewidth = 0.25, linetype = 2))

## Phosphorus run
breaks_P <- P_run %>%
  pull(hours_after_start) %>% 
  unique()

timepoints_P <- ifelse(breaks_P > 456, breaks_P - 504, breaks_P - 336)

P_run %>%
  ggplot(aes(x = hours_after_start, y = P, color = reactor)) +
  geom_line() +
  scale_x_continuous(breaks = breaks_P, labels = timepoints_P) +
  facet_wrap(~replicate, ncol = 1) +
  geom_vline(xintercept = c(456, 504, 624), color="#BB0000", linetype="dashed") +
  theme_classic() +
  labs(title = "Phosphorus Trends in Gravity-fed Column Reactors - Phosphorus Run", color = "Reactor:") +
  xlab("Hours After Start") +
  ylab ("Phosphorus Concentration (mg/L)") +
  theme(legend.position = "bottom",
        panel.grid.major = element_line(color = "grey", linewidth = 0.25, linetype = 2),
        panel.grid.minor = element_line(color = "grey", linewidth = 0.25, linetype = 2))

## Nitrate/Phosphorus run
breaks_N <- NP_run %>%
  pull(hours_after_start) %>% 
  unique()

timepoints_N <- ifelse(breaks_N > 792, breaks_N - 840, breaks_N - 672)

NP_run %>%
  ggplot(aes(x = hours_after_start, y = P, color = reactor)) +
  geom_line() +
  scale_x_continuous(breaks = breaks_N, labels = timepoints_N) +
  facet_wrap(~replicate, ncol = 1) +
  geom_vline(xintercept = c(792, 840, 960), color="#BB0000", linetype="dashed") +
  theme_classic() +
  labs(title = "Phosphorus Trends in Gravity-fed Column Reactors - Nitrate/Phosphorus Run", color = "Reactor:") +
  xlab("Hours After Start") +
  ylab ("Phosphorus Concentration (mg/L)") +
  theme(legend.position = "bottom",
        panel.grid.major = element_line(color = "grey", linewidth = 0.25, linetype = 2),
        panel.grid.minor = element_line(color = "grey", linewidth = 0.25, linetype = 2))
```

## Get the mean of the replicates
```{r}
## average the reps together
rep_mean_results <- icp_ic_results %>% 
  group_by(names) %>% 
  mutate(mean_Al = mean(Al),
         mean_Ca = mean(Ca),
         mean_Fe = mean(Fe),
         mean_Mg = mean(Mg),
         mean_Mn = mean(Mn),
         mean_P = mean(P),
         mean_S = mean(S),
         mean_Cl = mean(Cl),
         mean_NO2 = mean(NO2),
         mean_NO3 = mean(NO3),
         mean_PO4 = mean(PO4),
         mean_SO4 = mean(SO4)) %>% 
  ungroup() %>% 
  select(!c(sample_id, ICP_IC_batch, replicate, initial_p, initial_no3, Al, Ca, Fe, Mg, Mn, P, S, Cl, NO2, NO3, PO4, SO4)) %>% 
  distinct(.keep_all = TRUE)

## pull out stock measurements
stock_samples <- rep_mean_results %>% 
  filter(reactor == "STOCK") %>% 
  select(names, cycle, treatment, datetime, mean_Al, mean_Ca, mean_Fe, mean_Mg, mean_Mn, mean_P, mean_S, mean_Cl, mean_NO2, mean_NO3, mean_PO4, mean_SO4)

stock_P <- stock_samples %>% 
  select(cycle, treatment, mean_P) %>% 
  rename("initial_P" = "mean_P")

## subset the average data and create an initial P column using the stock checks
mean_controlrun <- rep_mean_results %>%
  filter(!reactor == "STOCK") %>%
  filter(!treatment == "P") %>% 
  filter(!treatment == "P+N") %>% 
  mutate(initial_p = ifelse(cycle == 1, 0.0164, 0.0123))

mean_Prun <- rep_mean_results %>% 
  filter(!reactor == "STOCK") %>%
  filter(!treatment == "Control")%>% 
  filter(!treatment == "P+N") %>% 
  mutate(initial_p = ifelse(cycle == 1, 0.250, 0.234))

mean_NPrun <- rep_mean_results %>% 
  filter(!reactor == "STOCK") %>%
  filter(!treatment == "Control")%>% 
  filter(!treatment == "P") %>% 
  mutate(initial_p = ifelse(cycle == 1, 0.188, 0.152))

## put the subsets back together into one dataset
tidyset <- rbind(mean_controlrun, mean_Prun, mean_NPrun) #%>% 
  #mutate(pchange = initial_p - mean_P)

tidyset %>% 
  mutate(decreaseP = ifelse(initial_p > mean_P, TRUE, FALSE)) %>% 
  mutate(P_change = initial_p - mean_P) %>% 
  ggplot(aes(x = hours_after_start, y = P_change, color = reactor)) + 
  geom_line() +
  scale_x_continuous(breaks = breaks, labels = timepoints) +
  #facet_wrap(~treatment, ncol = 1) +
  geom_vline(xintercept = c(120, 168, 288, 336, 456, 504, 624, 672, 792, 840, 960), color="#BB0000", linetype="dashed") +
  theme_classic() +
  labs(color = "Reactor:") +
  xlab("Hours After Start") +
  ylab ("Phosphorus removal (mg/L)") +
  theme(legend.position = "bottom",
        panel.grid.major = element_line(color = "grey", linewidth = 0.25, linetype = 2),
        panel.grid.minor = element_line(color = "grey", linewidth = 0.25, linetype = 2))

### left off here
```

## Cummulative plots
```{r}
breaks <- tidyset %>%
  pull(hours_after_start) %>% 
  unique()

timepoints <- c(timepoints_C, timepoints_P, timepoints_N)

# Full plot
tidyset %>%
  filter(!reactor == "STOCK") %>%
  ggplot(aes(x = hours_after_start, y = mean_P, color = reactor)) + 
  geom_line() +
  scale_x_continuous(breaks = breaks, labels = timepoints) +
  #facet_wrap(~treatment, ncol = 1) +
  geom_vline(xintercept = c(120, 168, 288, 336, 456, 504, 624, 672, 792, 840, 960), color="#BB0000", linetype="dashed") +
  theme_classic() +
  labs(color = "Reactor:") +
  xlab("Hours After Start") +
  ylab ("Phosphorus Concentration (mg/L)") +
  theme(legend.position = "bottom",
        panel.grid.major = element_line(color = "grey", linewidth = 0.25, linetype = 2),
        panel.grid.minor = element_line(color = "grey", linewidth = 0.25, linetype = 2))

# Control plot
control_plot <- tidyset %>%
  filter(!reactor == "STOCK") %>%
  filter(treatment == "Control") %>%
  ggplot(aes(x = hours_after_start, y = mean_P, color = reactor)) + 
  geom_line() +
  scale_x_continuous(breaks = breaks_C, labels = timepoints_C) +
  #facet_wrap(~treatment, ncol = 1) +
  geom_vline(xintercept = c(120, 168, 288), color="#BB0000", linetype="dashed") +
  theme_classic() +
  labs(color = "Reactor:") +
  ylim(c(0,0.3)) +
  xlab("Hours After Start") +
  ylab ("P Concentration (mg/L)") +
  theme(legend.position = "bottom",
        plot.margin = unit(c(1,1,1,1), "cm"),
        panel.grid.major = element_line(color = "grey", linewidth = 0.25, linetype = 2),
        panel.grid.minor = element_line(color = "grey", linewidth = 0.25, linetype = 2))

# P plot
P_plot <- tidyset %>%
  filter(!reactor == "STOCK") %>%
  filter(treatment == "P") %>%
  ggplot(aes(x = hours_after_start, y = mean_P, color = reactor)) + 
  geom_line() +
  scale_x_continuous(breaks = breaks_P, labels = timepoints_P) +
  #facet_wrap(~treatment, ncol = 1) +
  geom_vline(xintercept = c(456, 504, 624), color="#BB0000", linetype="dashed") +
  theme_classic() +
  labs(color = "Reactor:") +
  ylim(c(0,0.3)) +
  xlab("Hours After Start") +
  ylab ("P Concentration (mg/L)") +
  theme(legend.position = "bottom",
        plot.margin = unit(c(1,1,1,1), "cm"),
        panel.grid.major = element_line(color = "grey", linewidth = 0.25, linetype = 2),
        panel.grid.minor = element_line(color = "grey", linewidth = 0.25, linetype = 2))

# N/P plot
NP_plot <- tidyset %>%
  filter(!reactor == "STOCK") %>%
  filter(treatment == "P+N") %>%
  ggplot(aes(x = hours_after_start, y = mean_P, color = reactor)) + 
  geom_line() +
  scale_x_continuous(breaks = breaks_N, labels = timepoints_N) +
  #facet_wrap(~treatment, ncol = 1) +
  geom_vline(xintercept = c(792, 840, 960), color="#BB0000", linetype="dashed") +
  theme_classic() +
  labs(color = "Reactor:") +
  ylim(c(0,0.3)) +
  xlab("Hours After Start") +
  ylab ("P Concentration (mg/L)") +
  theme(legend.position = "bottom",
        plot.margin = unit(c(1,1,1,1), "cm"),
        panel.grid.major = element_line(color = "grey", linewidth = 0.25, linetype = 2),
        panel.grid.minor = element_line(color = "grey", linewidth = 0.25, linetype = 2))

ggarrange(control_plot, P_plot, NP_plot, ncol = 1, 
          labels = c("Control", "Phosphate", "Phosphate/Nitrate"), 
          hjust = -1, vjust = 1.5,
          common.legend = TRUE)
```

