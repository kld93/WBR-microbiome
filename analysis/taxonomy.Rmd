---
title: "Taxonomy - data from KBase Kaiju"
author: "Katie L. Duggan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---
## Files needed:

- "kaiju_taxonomy.csv" (output from Kaiju app in KBase - open .kaiju file in notepad and pasted data into csv file)

## Load packages
```{r, include=FALSE}
library(tidyverse)
#install.packages("pals")
library(pals)
library(vegan)
library(glue)
library(broom)
library(ggrepel)
```

## Load data
```{r}
taxonomy <- read_csv("C:/github/WBR-microbiome/data/kaiju_output_100nounclassified.csv")
### "kaiji_summaries.zip" was downloaded from KBase Kaiju app
### Phylum data was pasted into csv file
### Unclassified data is excluded

### "Unclassified" data was used to calculate total reads, then phylum percentages were re-calculated based on that total
```

## Taxonomy plot
```{r}
# Sort out low abundance phyla
taxa_nolowabund <- taxonomy %>% 
  dplyr::filter(percent > 1) %>% # Remove phyla that are < 1% abundant
  mutate(taxon_name = replace(taxon_name, taxon_name == 'Ascomycota', 'Ascomycota (fungi)')) %>% 
  mutate(name = ifelse(name == "7G", "7M", name)) %>% 
  mutate(name = ifelse(name == "9G", "9M", name)) %>% 
  mutate(name = ifelse(name == "11G", "11M", name)) %>% 
  mutate(name = ifelse(name == "8W", "8U", name)) %>% 
  mutate(name = ifelse(name == "10W", "10U", name)) %>% 
  mutate(name = ifelse(name == "12W", "12U", name))

sample_order <- c('7M', '9M', '11M', '8U', '10U', '12U') 

phyla_order <- c('Proteobacteria', 'Ascomycota (fungi)', 'Bacteroidetes', 'Chloroflexi', 'Verrucomicrobia', 'cannot be assigned to a (non-viral) phylum', 'belong to a (non-viral) phylum with less than 0.5% of all reads', 'Acidobacteria', 'Planctomycetes', 'Actinobacteria', 'Ignavibacteriae', 'Firmicutes')

phyla_order_reverse <- rev(phyla_order)

taxa_nolowabund %>%
  ggplot(aes(x = factor(name, level = sample_order), y = percent, fill = factor(taxon_name, level = phyla_order_reverse))) +
  #fill = fct_reorder(taxon_name, percent))) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~treatment, scales = "free") +
  scale_y_continuous(name = "Taxa Relative Abundance (%)", labels = scales::percent) +
  scale_fill_manual(values=as.vector(tol(12))) +
  xlab("Sample ID") +
  labs(fill = "Phylum") +
  theme_classic() +
  theme(axis.text = element_text(size = 12), 
        axis.title = element_text(size = 12), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 12), 
        strip.text = element_text(size = 12))
```


## Statistics
Subset the data by treatment:
```{r}
#ascomycota <- taxa_nolowabund %>% 
  #filter(taxon_name == "Ascomycota")
```

t-test for read count:
```{r}
#t.test(percent ~ treatment, data = ascomycota, alternative = "two.sided", paired = FALSE, conf.level = 0.95)
```


## Clustering exercise
```{r}
taxa_nolowabund

taxa_for_pcoa <- taxa_nolowabund %>% 
  mutate(total_reads = (reads*100)/percent)

### Follow Riffomonas tutorials from here:
### https://www.youtube.com/watch?v=xyufizOpc5I
### https://www.youtube.com/watch?v=G5Qckqq5Erw
### https://www.youtube.com/watch?v=_EjNR6YdnGM
```

#### Get matrix form
```{r}
shared <- taxa_for_pcoa %>% 
  select(name, reads, taxon_name) %>% 
  rename("value" = "reads") %>%
  select(name, taxon_name, value) %>%
  rename("Group" = "name") %>% 
  rename("name" = "taxon_name") %>% 
  group_by(Group) %>% 
  #summarize(total = sum(value)) %>% 
  #arrange(total) #this shows that 10W is the lowest 10W is the lowest at 15700522 reads
  mutate(total = sum(value)) %>%
  filter(total > 15700521) %>% 
  group_by(name) %>% 
  mutate(total = sum(value)) %>% 
  filter(total != 0) %>% 
  ungroup() %>% 
  select(-total) %>% 
  pivot_wider(names_from = name, values_from = value) %>% 
  replace(is.na(.), 0) %>%
  as.data.frame()

rownames(shared) <- shared$Group
shared <- shared[, -1] #remove name column
shared <- as.matrix(shared) #input for the functions from vegan (rows are samples, columns are taxa, values are the counts)
```

#### Calculating distances 
```{r}
set.seed(8675309)
dist <- avgdist(shared, dmethod = "bray", sample = 15700522) #rarefied based on lowest sample total (10W = 15700522)
nmds <- metaMDS(dist)

scores(nmds) %>% 
  as_tibble(rownames = "Group") %>%
  mutate(treatment = c("Milled", "Unmilled", "Milled", "Unmilled", "Milled", "Unmilled")) %>% 
  ggplot(aes(x = NMDS1, y = NMDS2, color = treatment)) +
  geom_point()
```

#### Build the ordination
```{r}
dist_matrix <- dist #to match riffomonas terminology

pcoa_tax <- cmdscale(dist_matrix, eig = TRUE, add = TRUE)
pcoa_tax

positions <- pcoa_tax$points
positions

colnames(positions) <- c("pcoa1", "pcoa2")

percent_explained <- 100* pcoa_tax$eig / sum(pcoa_tax$eig)

pretty_pe <- format(round(percent_explained[1:2], digits = 1), nsmall = 1, trim = TRUE)

labs <- c(glue("PCo 1 ({pretty_pe[1]}%)"),
          glue("PCo 2 ({pretty_pe[2]}%)"))

## Main formatted plot for paper:
positions %>% 
  as_tibble(rownames = "samples") %>% 
  mutate(treatment = c("Milled", "Unmilled", "Milled", "Unmilled", "Milled", "Unmilled")) %>% 
  ggplot(aes(x = pcoa1, y = pcoa2, color = treatment)) +
  geom_point(size = 3) #+
  #labs(x = labs[1], y = labs[2], color = "Treatment")

tibble(pe = percent_explained,
       axis = 1:length(percent_explained)) %>% 
  ggplot(aes(x = axis, y = pe)) +
  geom_line() #+
  #coord_cartesian(xlim = c(1,10))

cumsum(percent_explained) # you'd have to extend to the 4th axis to get 100% of the data explained
```

#### PERMANOVA
```{r}
metadata <- read.csv("C:/github/WBR-microbiome/data/pcoa_metadata.csv")

adonis2(dist_matrix ~ treatment, data = metadata)
```




(Not entirely sure what to make of the below plot - keep for now)

## Make a biplot
```{r}
set.seed(8675309)

# generate distance matrix - bray-curtis/rarefied to 2460412
dist <- avgdist(shared, dmethod = "bray", sample = 15700522) #rarefied based on lowest sample total (10W = 2460412)

# generate nmds ordination
nmds <- metaMDS(dist)

nmds_positions <- scores(nmds) %>% 
  as_tibble(rownames = "Group")

nmds_positions %>% 
  mutate(treatment = c("Milled", "Unmilled", "Milled", "Unmilled", "Milled", "Unmilled")) %>% 
  ggplot(aes(x = NMDS1, y = NMDS2, color = treatment)) +
  geom_point()

# what taxa are responsible for the position of each sample on this ordination?
# generate subsampled shared file
shared_tbl <- shared %>% 
  as_tibble(rownames = "Group")

subsample_shared_tbl <- shared_tbl %>% 
  pivot_longer(-Group) %>% 
  group_by(Group) %>% 
  mutate(total = sum(value)) %>% 
  filter(total > 2460412) %>% 
  uncount(value) %>% 
  slice_sample(n = 2460412) %>% 
  count(Group, name) %>% 
  pivot_wider(names_from = "name", values_from = "n", values_fill = 0) %>% 
  pivot_longer(-Group)

# correlate taxa with x and y axis positions
nmds_positions
subsample_shared_tbl

nmds_shared <- inner_join(subsample_shared_tbl, nmds_positions)

cor_x <- nmds_shared %>% 
  nest(data = -name) %>% 
  mutate(cor_x = map(data, ~cor.test(.x$value, .x$NMDS1, method = "spearman", exact = FALSE) %>% tidy())) %>% 
  unnest(cor_x) %>% 
  select(name, estimate, p.value)

cor_y <- nmds_shared %>% 
  nest(data = -name) %>% 
  mutate(cor_y = map(data, ~cor.test(.x$value, .x$NMDS2, method = "spearman", exact = FALSE) %>% tidy())) %>% 
  unnest(cor_y) %>% 
  select(name, estimate, p.value)

correlations <- inner_join(cor_x, cor_y, by = "name")

correlations %>% 
  filter(p.value.x < 0.05 | p.value.y < 0.05)

# plot segments from (0,0) to (Rx, Ry)
high_corr <- correlations

high_corr %>% 
  ggplot(aes(x = 0, xend = estimate.x, y = 0, yend = estimate.y)) +
  geom_segment()

nmds_positions %>% 
  mutate(treatment = c("Milled", "Unmilled", "Milled", "Unmilled", "Milled", "Unmilled")) %>% 
  ggplot(aes(x = NMDS1, y = NMDS2, color = treatment)) +
  geom_point() +
  geom_segment(data = high_corr, aes(x = 0, xend = estimate.x, y = 0, yend = estimate.y), inherit.aes = FALSE)

# plot text at (Rx, Ry)
nmds_positions %>% 
  mutate(treatment = c("Milled", "Unmilled", "Milled", "Unmilled", "Milled", "Unmilled")) %>% 
  ggplot(aes(x = NMDS1, y = NMDS2, color = treatment)) +
  geom_point() +
  #geom_segment(data = high_corr, aes(x = 0, xend = estimate.x, y = 0, yend = estimate.y), inherit.aes = FALSE) +
  geom_text_repel(data = high_corr, aes(x = estimate.x, y = estimate.y, label = name), min.segment.length = 0.05, inherit.aes = FALSE) +
  geom_point(data = high_corr, color = "black", aes(x = estimate.x, y = estimate.y), inherit.aes = FALSE)
```

Biplot - shows how the abundance of each OTU correlates with the position of each sample on the x and y axis of the ordination. 
Helpful for understanding the drivers of the differences we see in the communities.
